<!DOCTYPE html>
<html>
<head>
  <title>iFrame</title>
</head>
<body>
  <script src="../lib/uuid.core.js"></script>
  <script src="../lib/kamino.js"></script>
  <script src="../lib/message_channel.js"></script>
  <button id="hello">Send "Hello" to top window</button>
  <button id="yt">Send "yt" to top window</button>
  <script type="text/javascript">
    var destinationUrl = "http://localhost:8000",
        buttonHello = document.querySelector('#hello'),
        buttonYt = document.querySelector('#yt');
    var loadHandler = function(){
      var mc,
          mcYt;
      mc = new MessageChannel();
      mcYt = new MessageChannel();

      var clickHandler = function(){
        var msg = 'Hello';
        mc.port1.postMessage(msg);
      }
      buttonHello.addEventListener('click',clickHandler,false);

      var clickYtHandler = function(){
        var msg = 'yt';
        mcYt.port1.postMessage(msg);
      }
      buttonYt.addEventListener('click',clickYtHandler,false);

      // Send a port to our parent document.
      var data = Kamino.stringify( {type: 'documentAHasLoaded', ports: [mc.port2, mcYt.port2]} );
      window.parent.postMessage(data, destinationUrl);

      mc.port1.currentTarget = window.parent;
      mc.port1.destinationUrl = destinationUrl;
      mcYt.port1.currentTarget = window.parent;
      mcYt.port1.destinationUrl = destinationUrl;

      // Set up our port event listener.
      mc.port1.addEventListener( function( data ) {
        var t = document.createTextNode(data);
        document.body.appendChild(t);
      });
      // Open the port
      mc.port1.start();

      var messageHandler = function( messageEvent ) {
        if(messageEvent.origin !== destinationUrl) {
          return;
        }

        var data = Kamino.parse( messageEvent.data ),
            port;

        // Retrieve the port
        if( data['target']) {
          // Recreate the entangled ports
          port = window.messagePorts[ data.target]

          port.dispatchEvent( data.data );
        }
      };
      window.addEventListener('message',messageHandler,false);
    }

    window.addEventListener('DOMContentLoaded', loadHandler, false);
  </script>
</body>
</html>

