<!DOCTYPE html>
<html>
<head>
  <title>iFrame</title>
  <script src="../../lib/uuid.core.js"></script>
  <script src="../../lib/kamino.js"></script>
  <script src="../../lib/message_channel.js"></script>
</head>
<body>
  <script type="text/javascript">
    var destinationUrl = "http://localhost:8001";
    var loadHandler = function(){
      var mc = new MessageChannel();

      // Send a port to our parent document.
      var data = Kamino.stringify( {type: 'documentAHasLoaded', ports: [mc.port2]} );
      window.parent.postMessage(data, destinationUrl);

      mc.port1.currentTarget = window.parent;
      mc.port1.destinationUrl = destinationUrl;

      // Set up our port event listener.
      mc.port1.addEventListener( function( data ) {
        var li = document.createElement('li')
            t = document.createTextNode( data ),
            ul = document.querySelector('ul');
        li.appendChild( t );
        ul.appendChild( li );
      });
      // Open the port
      mc.port1.start();

      // window message handler
      var messageHandler = function( messageEvent ) {
        if(messageEvent.origin !== destinationUrl) {
          return;
        }

        var data = Kamino.parse( messageEvent.data ),
            port;

        // Retrieve the port
        if( data['target']) {
          // Recreate the entangled ports
          port = window.messagePorts[ data.target]

          port.dispatchEvent( data.data );
        }
      };
      window.addEventListener('message',messageHandler,false);
    }

    window.addEventListener('DOMContentLoaded', loadHandler, false);
  </script>
  <ul></ul>
</body>
</html>

