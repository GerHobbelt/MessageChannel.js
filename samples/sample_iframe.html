<!DOCTYPE html>
<html>
<head>
  <title>Sample iFrame</title>
</head>
<body>
  <script src="../lib/uuid.core.js"></script>
  <script src="../lib/kamino.js"></script>
  <script src="../lib/message_channel.js"></script>
  <button id="hello">Send "Hello" to top window</button>
  <button id="yt">Send "yt" to top window</button>
  <script type="text/javascript">
    var destinationUrl = window.location.protocol + "//" + window.location.hostname + ":" + (parseInt(window.location.port) - 1),
        buttonHello = document.querySelector('#hello'),
        buttonYt = document.querySelector('#yt');
    var loadHandler = function(){
      var mc,
          mcYt;
      mc = new MessageChannel();
      mcYt = new MessageChannel();

      var clickHandler = function(){
        var msg = 'Hello';
        mc.port1.postMessage(msg);
      }
      buttonHello.addEventListener('click',clickHandler,false);

      var clickYtHandler = function(){
        var msg = 'yt';
        mcYt.port1.postMessage(msg);
      }
      buttonYt.addEventListener('click',clickYtHandler,false);

      // Send a port to our parent document.
      MessageChannel.postMessagePorts( window.parent, 'documentAHasLoaded', destinationUrl, [mc.port2, mcYt.port2]);

      // Set up our port event listener.
      mc.port1.addEventListener( 'message', function( data ) {
        var li = document.createElement('li')
            t = document.createTextNode( data ),
            ul = document.querySelector('ul');
        li.appendChild( t );
        ul.appendChild( li );
      });
      // Open the port
      mc.port1.start();

      var messageHandler = function( messageEvent ) {
        if(messageEvent.origin !== destinationUrl) {
          return;
        }

        var data = Kamino.parse( messageEvent.data ),
            port;

        // Retrieve the port
        if( data['target']) {
          // Recreate the entangled ports
          port = window.messagePorts[ data.target]

          port.dispatchEvent( data.data );
        }
      };
      window.addEventListener('message',messageHandler,false);
    }

    window.addEventListener('DOMContentLoaded', loadHandler, false);
  </script>
  <div><ul></ul></div>
</body>
</html>

