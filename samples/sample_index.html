<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sample Window</title>
</head>
<body>
  <script src="../lib/uuid.core.js"></script>
  <script src="../lib/kamino.js"></script>
  <script src="../lib/message_channel.js"></script>

  <button>Send to iframe</button>
  <script type="text/javascript">
    var destinationUrl = window.location.protocol + "//" + window.location.hostname + ":" + (parseInt(window.location.port) + 1),
        button = document.querySelector('button');
    var loadHandler = function(){
      // Define our message handler.
      var messageHandler = function(messageEvent){

        if(messageEvent.origin !== destinationUrl) {
          return;
        }

        var fakeEvent = MessageChannel.decodeEvent( messageEvent );

        // Retrieve the port
        if( fakeEvent.data === "documentAHasLoaded" ) {
          var ports = fakeEvent.ports;

          for(var i=0 ; i<ports.length ; i++) {
            // Define our message event handler.
            ports[i].addEventListener( 'message', function( event ) {
              var li = document.createElement('li')
                  t = document.createTextNode( event.data ),
                  ul = document.querySelector('ul');
              li.appendChild( t );
              ul.appendChild( li );
            });

            // Open the port
            ports[i].start();
          }

          // Our form submission handler
          var clickHandler = function(){
            var msg = 'add <foo@example.com> to game circle.';
            ports[0].postMessage(msg);
          }
          button.addEventListener('click',clickHandler,false);
        }

        MessageChannel.propagateEvent( fakeEvent );
      }

      // Listen for the message from iframe[0]
      window.addEventListener('message', messageHandler, false);
    }
    window.addEventListener('DOMContentLoaded', loadHandler, false);

    var iframe = document.createElement('iframe');
    iframe.setAttribute("src", destinationUrl + "/samples/sample_iframe.html");
    document.body.appendChild( iframe );
  </script>
  <div><ul></ul></div>
</body>
</html>
